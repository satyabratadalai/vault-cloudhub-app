pipeline {
    agent any
    environment {
        MAVEN_OPTS = "--add-opens=java.base/sun.net.www.protocol.jar=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED"
    }
    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/satyabratadalai/vault-cloudhub-app.git', branch: 'main'
            }
        }
        
        stage('Fetch Secrets') {
            steps {
                script {
                    def vaultPath = ''
                    echo "Environment Selected: ${ENV}"
                    if (ENV == 'DEV') {
                        vaultPath = "secret/mulesoft-dev"
                    } else if (ENV == 'UAT') {
                        vaultPath = "secret/mulesoft-uat"
                    } else if (ENV == 'PROD') {
                        vaultPath = "secret/mulesoft-prod"
                    } else {
                        echo "INVALID ENV"
                        return // Exit the stage if the environment is invalid
                    }

                    // Fetch secrets from Vault
                    def secrets = [
                        [$class: 'VaultSecret', path: vaultPath, secretValues: [
                            [$class: 'VaultSecretValue', envVar: 'DATABASE_USERNAME', vaultKey: 'database.username'],
                            [$class: 'VaultSecretValue', envVar: 'DATABASE_PASSWORD', vaultKey: 'database.password']
                        ]]
                    ]
                    withVault([vaultSecrets: secrets, vaultConfigurationId: 'vault-token']) {
                        // Store the credentials in environment variables
                        env.DATABASE_USERNAME = env.DATABASE_USERNAME ?: 'DUMMY' // Fallback to 'DUMMY' if null
                        env.DATABASE_PASSWORD = env.DATABASE_PASSWORD ?: 'DUMMY' // Fallback to 'DUMMY' if null
                    }
                }
            }
        }

        stage('Exchange') {
            steps {
                withMaven(maven: 'Maven', mavenSettingsConfig: '3802749b-765f-4b02-86ab-bcf94c417beb') {
                    // Pass credentials safely without exposing them in the console
                    withEnv(["DATABASE_USERNAME=${env.DATABASE_USERNAME}", "DATABASE_PASSWORD=${env.DATABASE_PASSWORD}"]) {
                        sh 'mvn clean deploy -Ddatabase.username=$DATABASE_USERNAME -Ddatabase.password=$DATABASE_PASSWORD'
                    }
                }
            }
        }

        stage('Cloudhub 2.0') {
            steps {
                withMaven(maven: 'Maven', mavenSettingsConfig: '3802749b-765f-4b02-86ab-bcf94c417beb') {
                    // Masking the environment variables within the Maven command
                    withEnv(["DATABASE_USERNAME=${env.DATABASE_USERNAME}", "DATABASE_PASSWORD=${env.DATABASE_PASSWORD}"]) {
                        sh 'mvn clean deploy -DmuleDeploy -Ddatabase.username=$DATABASE_USERNAME -Ddatabase.password=$DATABASE_PASSWORD'
                    }
                }
            }
        }
    }
}
