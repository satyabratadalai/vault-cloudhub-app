pipeline {
    agent any
    environment {
        // Include all necessary --add-opens options
        MAVEN_OPTS = "--add-opens=java.base/sun.net.www.protocol.jar=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED"
    }
    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/satyabratadalai/vault-cloudhub-app.git', branch: 'main'
            }
        }
        
        stage('Modifying POM File : Pre Deployment') {
            steps {
                script {
                    // Load the pom.xml file content
                    def pomContent = readFile 'pom.xml'
                    
                    // Modify the content using a safer Groovy string manipulation
                    pomContent = pomContent.replaceFirst('<database.username>.*?</database.username>', '<database.username>HELLO</database.username>')
                    pomContent = pomContent.replaceFirst('<database.password>.*?</database.password>', '<database.password>HELLO PASS</database.password>')

                    // Write the modified content back to pom.xml
                    writeFile file: 'pom.xml', text: pomContent
                }
            }
        }

        stage('Build') {
            steps {
                withMaven(maven: 'Maven', mavenSettingsConfig: '3802749b-765f-4b02-86ab-bcf94c417beb') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Upload to Exchange') {
            steps {
                echo "LETS DEPLOY"
                withMaven(maven: 'Maven', mavenSettingsConfig: '3802749b-765f-4b02-86ab-bcf94c417beb') {
                    sh 'mvn clean deploy'
                }
            }
        }

        stage('Deploy To Cloudhub 2.0') {
            steps {
                echo "LETS DEPLOY"
                withMaven(maven: 'Maven', mavenSettingsConfig: '3802749b-765f-4b02-86ab-bcf94c417beb') {
                    sh 'mvn clean deploy -DmuleDeploy'
                }
            }
        }
    }
}
